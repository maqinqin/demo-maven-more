<%@ page contentType="text/html;charset=UTF-8"%>
<%@ page import="net.sf.jasperreports.engine.*" %>
<%@ page import="java.util.*" %>
<%@ page import="java.io.*" %>
<%@ page import="java.sql.*" %>
<%@ page import="net.sf.jasperreports.j2ee.servlets.ImageServlet" %>
<%@ page language="Java" pageEncoding="UTF-8"%>
<%@ page import="net.sf.jasperreports.engine.export.*" %>
<%@ page import="org.springframework.ui.jasperreports.JasperReportsUtils" %>
<%
	String timeLine = request.getParameter("timeLine");
	String timeLineNext = request.getParameter("timeLineNext");
	String queryvmType = request.getParameter("queryvmType");
	//报表编译之后生成的.jasper文件的存放位置
	File reportFile = new File(this.getServletContext().getRealPath("/pages/reports/appDevInfo/AppDevInfoOfCommon.jasper"));
	
	if(!reportFile.exists()) {
		throw new JRRuntimeException("报表文件 AppDevInfo.jasper 不存在！");
	}
	//读取数据库的配置文件
	Properties prop = new Properties();     
    InputStream in = null;
    String url="";
    String userName = "";
    String password = "";
	try {
		in = new BufferedInputStream (new FileInputStream(this.getServletContext().getRealPath("/WEB-INF/classes/config/jdbc.properties")));
		prop.load(in);  
		url = prop.getProperty("jdbc.url");
		userName = prop.getProperty("jdbc.username");
		password = prop.getProperty("jdbc.password");
	} catch (FileNotFoundException e) {
		e.printStackTrace();
	}finally{
		in.close();
	}
	Class.forName("com.mysql.jdbc.Driver");
	//jsper所需参数
	Map parameters = new HashMap();
	//"SQLSTR"是报表中定义的一个参数名称,用来存放将要执行的sql语句,其类型为String 型
	String str = "SELECT 	COUNT(stat.STAT_ID), app.APP_ID, app.CNAME AS appName, (SELECT 	IFNULL(COUNT(statSupply.STAT_ID),0) FROM 	APP_STAT statSupply LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 	statSupply.APP_ID = stat.APP_ID AND statSupply.SR_TYPE_MARK = 'VS' AND statSupply.CREATE_TIME < '"+timeLine+"')- (SELECT IFNULL(COUNT(statRecycle.STAT_ID),0) FROM	APP_STAT statRecycle LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = 'vmvare' AND    statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME < '"+timeLine+"') AS vmRemain, (SELECT	IFNULL(COUNT(statSupply.STAT_ID),0)	FROM 	APP_STAT statSupply LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 	statSupply.APP_ID = stat.APP_ID AND statSupply.SR_TYPE_MARK = 'VS' AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"') AS vmSupply,(SELECT COUNT(statRecycle.STAT_ID) 	FROM 	APP_STAT statRecycle 	LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"') AS vmRecycle,(SELECT 	IFNULL(SUM(statNotRecycle.CPU),0) FROM 	APP_STAT statNotRecycle LEFT JOIN CM_VM vm ON vm.ID = statNotRecycle.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y' LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE	statNotRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND statNotRecycle.APP_ID = stat.APP_ID AND statNotRecycle.SR_TYPE_MARK = 'VS' AND statNotRecycle.CREATE_TIME < '"+timeLine+"')- (SELECT 	IFNULL(SUM(statRecycle.CPU),0)	FROM 	APP_STAT statRecycle 	LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y' 	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 	statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME < '"+timeLine+"') AS cpuRemain,(SELECT IFNULL(SUM(statSupply.CPU),0) 	FROM 	APP_STAT statSupply LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' 	LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  						LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 	LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 						statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 				statSupply.APP_ID = stat.APP_ID AND statSupply.SR_TYPE_MARK = 'VS' AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"') AS cpuSupply,	(SELECT 						IFNULL(SUM(statRecycle.CPU),0) FROM 	APP_STAT statRecycle	LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y'	LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 	LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND  statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"') AS cpuRecycle,	(SELECT 		IFNULL(SUM(statNotRecycle.MEM),0) 	FROM 		APP_STAT statNotRecycle 		LEFT JOIN CM_VM vm ON vm.ID = statNotRecycle.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' 		LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y' 	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y'	WHERE 	statNotRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 	statNotRecycle.APP_ID = stat.APP_ID AND statNotRecycle.SR_TYPE_MARK <> 'VR' AND statNotRecycle.CREATE_TIME < '"+timeLine+"')-		(SELECT 	IFNULL(SUM(statRecycle.MEM),0) FROM 						APP_STAT statRecycle LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y'	LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  			LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 	statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 	statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME < '"+timeLine+"') AS memRemain,	(SELECT  	IFNULL(SUM(statSupply.MEM),0) 					FROM 	APP_STAT statSupply 	LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' 	LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 	LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE 	statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND statSupply.APP_ID = stat.APP_ID AND statSupply.SR_TYPE_MARK <> 'VR' AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"') AS memSupply,	(SELECT 						IFNULL(SUM(statRecycle.MEM),0) FROM 						APP_STAT statRecycle 	LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  						LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 	LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE 						statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 				statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"') AS memRecycle,(SELECT 		IFNULL(SUM(statNotRecycle.DISK),0) 	FROM 		APP_STAT statNotRecycle 		LEFT JOIN CM_VM vm ON vm.ID = statNotRecycle.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' 						LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 		WHERE 			statNotRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 				statNotRecycle.APP_ID = stat.APP_ID AND statNotRecycle.SR_TYPE_MARK <> 'VR' AND statNotRecycle.CREATE_TIME < '"+timeLine+"')- 				(SELECT 	IFNULL(SUM(statRecycle.DISK),0) 					FROM 	APP_STAT statRecycle 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 	LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' 	LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  	LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE 	statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 	statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME < '"+timeLine+"') AS diskRemain,(SELECT 	IFNULL(SUM(statSupply.DISK),0) 		FROM 	APP_STAT statSupply LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y' 			LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 		statSupply.APP_ID = stat.APP_ID AND statSupply.SR_TYPE_MARK <> 'VR' AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"') AS diskSupply,	(SELECT 			IFNULL(SUM(statRecycle.DISK),0) 		FROM 						APP_STAT statRecycle 	LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 	LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y'	LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  				LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 	LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED' AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"' AND 		statRecycle.APP_ID = stat.APP_ID AND statRecycle.SR_TYPE_MARK = 'VR' AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"') AS diskRecycle  FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y' LEFT JOIN CM_VM vm ON vm.ID = stat.DEVICE_ID LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID LEFT JOIN CM_DEVICE vmDev ON vmDev.ID = vm.ID AND vmDev.IS_ACTIVE = 'Y' LEFT JOIN CM_DEVICE hostDev ON hostDev.ID = hst.ID AND hostDev.IS_ACTIVE = 'Y'  LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' WHERE stat.SR_STATUS_CODE = 'REQUEST_CLOSED'  GROUP BY stat.APP_ID";
	String sqlStrForPic = "SELECT c.APP_ID AS appId,c.CNAME AS appName,'留存虚拟机' as category ,(c.total-d.total) AS val FROM  (SELECT a.APP_ID,a.CNAME,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, COUNT(statSupply.STAT_ID) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME < '"+timeLine+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID)c  LEFT JOIN  (SELECT a.APP_ID,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT 	app.APP_ID,	app.CNAME, COUNT(statRecycle.STAT_ID) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME < '"+timeLine+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID)d   ON d.APP_ID = c.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'供给虚拟机' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, COUNT(statSupply.STAT_ID) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'回收虚拟机' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, COUNT(statRecycle.STAT_ID) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT c.APP_ID AS appId,c.CNAME AS appName,'留存CPU' as category ,(c.total-d.total) AS val FROM  (SELECT a.APP_ID,a.CNAME,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statSupply.CPU) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME < '"+timeLine+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID)c  LEFT JOIN  (SELECT a.APP_ID,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT 	app.APP_ID,	app.CNAME, SUM(statRecycle.CPU) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME < '"+timeLine+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID)d   ON d.APP_ID = c.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'供给CPU' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statSupply.CPU) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'回收CPU' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statRecycle.CPU) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT c.APP_ID AS appId,c.CNAME AS appName,'留存内存' as category ,(c.total-d.total) AS val FROM  (SELECT a.APP_ID,a.CNAME,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statSupply.MEM) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME < '"+timeLine+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID)c  LEFT JOIN  (SELECT a.APP_ID,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT 	app.APP_ID,	app.CNAME, SUM(statRecycle.MEM) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME < '"+timeLine+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID)d   ON d.APP_ID = c.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'供给内存' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statSupply.MEM) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'回收内存' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statRecycle.MEM) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT c.APP_ID AS appId,c.CNAME AS appName,'留存磁盘' as category ,(c.total-d.total) AS val FROM  (SELECT a.APP_ID,a.CNAME,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statSupply.DISK) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME < '"+timeLine+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID)c  LEFT JOIN  (SELECT a.APP_ID,IFNULL(b.total,0) AS total FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT 	app.APP_ID,	app.CNAME, SUM(statRecycle.DISK) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME < '"+timeLine+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID)d   ON d.APP_ID = c.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'供给磁盘' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statSupply.DISK) AS total 	FROM 		APP_STAT statSupply 		RIGHT JOIN APP_INFO app ON app.APP_ID = statSupply.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statSupply.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statSupply.SR_TYPE_MARK = 'VS'  		AND statSupply.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statSupply.CREATE_TIME > '"+timeLine+"' AND statSupply.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statSupply.APP_ID)b ON a.APP_ID = b.APP_ID   UNION ALL   SELECT a.APP_ID AS appId,a.CNAME AS appName,'回收磁盘' as category ,IFNULL(b.total,0) AS val FROM  (SELECT DISTINCT app.* FROM APP_STAT stat LEFT JOIN APP_INFO app ON app.APP_ID = stat.APP_ID AND app.IS_ACTIVE = 'Y') a LEFT JOIN (SELECT	app.APP_ID,app.CNAME, SUM(statRecycle.DISK) AS total 	FROM 		APP_STAT statRecycle 		RIGHT JOIN APP_INFO app ON app.APP_ID = statRecycle.APP_ID AND app.IS_ACTIVE = 'Y' 		LEFT JOIN CM_VM vm ON vm.ID = statRecycle.DEVICE_ID 		LEFT JOIN CM_HOST hst ON hst.ID = vm.HOST_ID 		LEFT JOIN RM_CLUSTER clu ON clu.ID = hst.CLUSTER_ID AND clu.IS_ACTIVE = 'Y' 		LEFT JOIN RM_VIRTUAL_TYPE vmType ON vmType.VIRTUAL_TYPE_ID = clu.VM_TYPE AND vmType.IS_ACTIVE = 'Y' 	WHERE 		statRecycle.SR_TYPE_MARK = 'VR'  		AND statRecycle.SR_STATUS_CODE = 'REQUEST_CLOSED'  		AND vmType.VIRTUAL_TYPE_NAME = '"+queryvmType+"'  		AND statRecycle.CREATE_TIME > '"+timeLine+"' AND statRecycle.CREATE_TIME < '"+timeLineNext+"' GROUP BY 	statRecycle.APP_ID)b ON a.APP_ID = b.APP_ID   ";
	parameters.put("sqlStr",str);
	parameters.put("sqlStrForPic",sqlStrForPic);
	parameters.put("TIMELINE",timeLine);
	parameters.put("TIMELINENEXT",timeLineNext);
	parameters.put("VMTYPE",queryvmType);
	parameters.put("SERVERNAME",request.getServerName());
	parameters.put("SERVERPORT",request.getServerPort());
	parameters.put("CONTEXTPATH",request.getContextPath());
	Connection conn = DriverManager.getConnection(url,userName,password);
	System.out.println("sqlforpic: "+sqlStrForPic);
	//获得Jasper输入流
	InputStream inputStream = this.getServletContext().getResourceAsStream("/reports/appDevInfo/AppDevInfoOfCommon.jasper");
	//获得JasperPrint对象
	JasperPrint jasperPrint = new JasperPrint();
	try{
		jasperPrint = JasperFillManager.fillReport(inputStream, parameters, conn);
	}catch(Exception e){
		System.out.println("******zhangjunxin*******:"+e.getMessage());
	}
	//关闭数据库连接
	conn.close();
	//设置格式
	response.setContentType("text/html;charset=UTF-8");
	//获得输出流 ,这里不能这样response.getOutputStream()
	PrintWriter printWriter = response.getWriter();
	//创建JRHtmlExporter对象
	JRHtmlExporter htmlExporter = new JRHtmlExporter();
	//把jasperPrint到Session里面(net.sf.jasperreports.j2ee.jasper_print)
	request.getSession().setAttribute(ImageServlet.DEFAULT_JASPER_PRINT_SESSION_ATTRIBUTE, jasperPrint);
	//设值jasperPrint
	htmlExporter.setParameter(JRExporterParameter.JASPER_PRINT,jasperPrint);
	//设置输出
	htmlExporter.setParameter(JRExporterParameter.OUTPUT_WRITER,printWriter);
	//设置图片生成的Servlet(生成图片就用这个ImageServlet,并且要在XML文件里面配置 image?image=这个是Servlet的url-pattern)
	//flush随机数用于重新获取图片（更新图片地址），否则条件改变后图片不会随之发生改变
	htmlExporter.setParameter(JRExporterParameter.CHARACTER_ENCODING, "UTF-8");
	htmlExporter.setParameter(JRHtmlExporterParameter.IMAGES_URI,request.getContextPath()+"/servlets/image?image=");
	//解决生成HTML报表缩小问题
	//htmlExporter.setParameter(JRHtmlExporterParameter.SIZE_UNIT, "pt");
	htmlExporter.setParameter(JRHtmlExporterParameter.SIZE_UNIT, JRHtmlExporterParameter.SIZE_UNIT_POINT);
	//导出
	htmlExporter.exportReport();
	//关闭输出流
	printWriter.close();
	//关闭输入流
	inputStream.close();
	
%>   

 <html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>Telecommunications Data Collection System</title>
</head>
<body> </body >

</body>
</html> 
